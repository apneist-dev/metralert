# Server

Сервер метрик — это HTTP-сервер, который собирает, хранит и предоставляет доступ к различным метрикам системы. Он поддерживает несколько типов метрик, включая счетчики (counter) и измерители (gauge), и предоставляет API для их обновления и получения.

## Основные функции

- **Сбор метрик**: Сервер может собирать различные метрики системы, включая метрики времени выполнения Go и метрики использования памяти.
- **Хранение метрик**: Метрики могут храниться в файле или в базе данных PostgreSQL.
- **API**: Сервер предоставляет RESTful API для обновления и получения метрик.
- **Проверка целостности**: Поддерживает проверку целостности данных с помощью HMAC-хеширования.
- **Сжатие данных**: Поддерживает сжатие данных с помощью gzip.
- **Аудит**: Ведет журнал аудита для отслеживания изменений метрик.

## Конфигурация

Сервер можно настроить с помощью флагов командной строки или переменных окружения:

| Флаг | Переменная окружения | Описание | Значение по умолчанию |
| :--- | :--- | :--- | :--- |
| `-a` | `ADDRESS` | Адрес сервера | `localhost:8080` |
| `-i` | `STORE_INTERVAL` | Интервал сохранения метрик в файл (в секундах) | `300` |
| `-f` | `FILE_STORAGE_PATH` | Путь к файлу для хранения метрик | `metrics_database.json` |
| `-r` | `RESTORE` | Восстанавливать метрики при запуске | `true` |
| `-d` | `DATABASE_DSN` | Строка подключения к базе данных PostgreSQL |  |
| `-k` | `KEY` | Ключ для HMAC-хеширования |  |
| `--audit-file` | `AUDIT_FILE` | Путь к файлу журнала аудита |  |
| `--audit-url` | `AUDIT_URL` | URL для отправки журнала аудита |  |

## API

### Обновление метрики

- `POST /update/{metrictype}/{metricname}/{metricvalue}`: Обновляет метрику с указанным типом, именем и значением.
- `POST /update/`: Обновляет метрику, переданную в теле запроса в формате JSON.
- `POST /updates/`: Обновляет пакет метрик, переданных в теле запроса в формате JSON.

### Получение метрики

- `GET /value/{metrictype}/{metricname}`: Возвращает значение метрики с указанным типом и именем.
- `POST /value/`: Возвращает метрику, переданную в теле запроса в формате JSON.

### Другие endpoints

- `GET /`: Возвращает HTML-страницу со всеми метриками.
- `GET /ping`: Проверяет подключение к базе данных.

## Запуск

Для запуска сервера выполните следующую команду:

```bash
go run cmd/server/main.go [флаги]
```

Пример:

```bash
go run cmd/server/main.go -a localhost:8080 -d "postgres://postgres:postgres@localhost:5432/praktikum?sslmode=disable"
```

### Информация о сборке

При сборке сервера можно передать информацию о версии, дате сборки и коммите с помощью флагов ldflags:

```bash
go build -ldflags "-X main.buildVersion=v1.0.0 -X main.buildDate=2023-10-27 -X main.buildCommit=abc123" cmd/server/main.go
```

После запуска сервер выведет эту информацию в консоль.